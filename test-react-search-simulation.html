<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>React Search Simulation Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 30px;
    }
    .container {
      max-width: 900px;
      margin: 0 auto;
      background: white;
      border-radius: 16px;
      padding: 40px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.3);
    }
    h1 {
      color: #1a202c;
      font-size: 28px;
      margin-bottom: 10px;
    }
    .subtitle {
      color: #718096;
      margin-bottom: 30px;
    }
    .search-box {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
    }
    input {
      flex: 1;
      padding: 12px 16px;
      border: 2px solid #e2e8f0;
      border-radius: 8px;
      font-size: 16px;
    }
    button {
      padding: 12px 24px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      border-radius: 8px;
      font-weight: 600;
      cursor: pointer;
    }
    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
    }
    .status {
      padding: 15px;
      border-radius: 8px;
      margin: 15px 0;
    }
    .status.info { background: #bee3f8; color: #2c5282; }
    .status.success { background: #c6f6d5; color: #22543d; }
    .status.error { background: #fed7d7; color: #742a2a; }
    .log {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 15px;
      margin: 15px 0;
      font-family: monospace;
      font-size: 12px;
      max-height: 300px;
      overflow-y: auto;
    }
    .log-entry {
      padding: 5px 0;
      border-bottom: 1px solid #e2e8f0;
    }
    .log-entry:last-child {
      border-bottom: none;
    }
    .result-card {
      border: 1px solid #e2e8f0;
      padding: 15px;
      margin: 10px 0;
      border-radius: 8px;
      background: #f7fafc;
    }
    .result-card h3 {
      color: #2d3748;
      margin-bottom: 8px;
    }
    .result-card .info {
      color: #4a5568;
      font-size: 14px;
      line-height: 1.6;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>üß™ React Search Simulation</h1>
    <p class="subtitle">This test simulates exactly how the React app performs searches</p>

    <div class="search-box">
      <input
        type="text"
        id="searchInput"
        placeholder="Enter medication name (e.g., Mounjaro)"
        onkeypress="if(event.key === 'Enter') simulateSearch()"
      >
      <button onclick="simulateSearch()" id="searchBtn">Search</button>
    </div>

    <div id="status"></div>
    <div id="results"></div>

    <h3 style="margin-top: 30px; margin-bottom: 10px;">Console Log</h3>
    <div id="log" class="log"></div>
  </div>

  <script>
    // Exact configuration from src/lib/supabase.ts
    const CORRECT_PROJECT_REF = 'nuhfqkhplldontxtoxkg';
    const CORRECT_SUPABASE_URL = `https://${CORRECT_PROJECT_REF}.supabase.co`;
    const CORRECT_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51aGZxa2hwbGxkb250eHRveGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NzQyODYsImV4cCI6MjA3MzQ1MDI4Nn0.ceTZ_YZtqCRv2v3UCgHM42OXdb97KrmVhnxgk0iD3eE';

    // Create Supabase client exactly as in the app
    const supabase = window.supabase.createClient(CORRECT_SUPABASE_URL, CORRECT_ANON_KEY, {
      auth: {
        autoRefreshToken: true,
        persistSession: true,
        detectSessionInUrl: true,
        flowType: 'pkce',
        storage: window.localStorage,
        storageKey: `sb-${CORRECT_PROJECT_REF}-auth-token`
      }
    });

    const logs = [];

    function addLog(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      logs.push(`[${timestamp}] ${message}`);

      const logEl = document.getElementById('log');
      const entry = document.createElement('div');
      entry.className = 'log-entry';
      entry.textContent = `[${timestamp}] ${message}`;
      logEl.appendChild(entry);
      logEl.scrollTop = logEl.scrollHeight;

      console.log(message);
    }

    function showStatus(message, type = 'info') {
      const statusEl = document.getElementById('status');
      statusEl.className = `status ${type}`;
      statusEl.textContent = message;
    }

    function showResults(html) {
      document.getElementById('results').innerHTML = html;
    }

    // This mimics searchPharmaPrograms from src/services/searchService.ts
    async function searchPharmaPrograms(query, limit = 20) {
      // Validate input
      if (!query || query.trim().length === 0) {
        addLog('Empty query, returning empty array');
        return [];
      }

      if (query.trim().length < 2) {
        addLog('Query too short (< 2 chars), returning empty array');
        return [];
      }

      const searchTerm = query.trim();
      const startTime = performance.now();

      addLog(`Starting search for: "${searchTerm}"`);

      try {
        // Primary method: Use optimized RPC function with pg_trgm
        addLog('Calling supabase.rpc("search_pharma_programs", ...)');
        const { data, error } = await supabase.rpc('search_pharma_programs', {
          search_query: searchTerm,
          result_limit: limit
        });

        const duration = performance.now() - startTime;

        if (error) {
          addLog(`‚ùå RPC error: ${error.message}`, 'error');
          throw new Error(`Search failed: ${error.message}`);
        }

        if (!data || data.length === 0) {
          addLog(`No results for "${searchTerm}" (${duration.toFixed(0)}ms)`);
          return [];
        }

        addLog(`‚úÖ Found ${data.length} results for "${searchTerm}" in ${duration.toFixed(0)}ms`);
        return data;

      } catch (err) {
        addLog(`‚ùå Search error: ${err.message}`, 'error');
        throw err;
      }
    }

    // This mimics the SearchBar component behavior
    async function simulateSearch() {
      const input = document.getElementById('searchInput');
      const query = input.value;
      const btn = document.getElementById('searchBtn');

      // Clear previous results
      showResults('');
      addLog('=== NEW SEARCH STARTED ===');
      addLog(`User input: "${query}"`);

      if (!query || query.trim().length < 2) {
        showStatus('Please enter at least 2 characters', 'error');
        addLog('Validation failed: Query too short');
        return;
      }

      try {
        btn.disabled = true;
        showStatus('üîÑ Searching...', 'info');

        const results = await searchPharmaPrograms(query, 20);

        if (results.length === 0) {
          showStatus('No programs match your search. Try different keywords.', 'info');
          showResults('<div class="status info">No results found. Try searching for: Mounjaro, Ozempic, Humira, Insulin</div>');
          addLog('No results to display');
        } else {
          showStatus(`‚úÖ Found ${results.length} matching programs`, 'success');
          addLog(`Rendering ${results.length} results`);

          let html = '<h3 style="margin-bottom: 15px;">Search Results</h3>';
          results.forEach((program, i) => {
            const similarity = program.similarity ? (program.similarity * 100).toFixed(0) : 'N/A';
            html += `
              <div class="result-card">
                <h3>${i + 1}. ${program.medication_name} (${similarity}% match)</h3>
                <div class="info">
                  <strong>Generic:</strong> ${program.generic_name || 'N/A'}<br>
                  <strong>Manufacturer:</strong> ${program.manufacturer}<br>
                  <strong>Program:</strong> ${program.program_name}<br>
                  <strong>Savings:</strong> ${program.discount_amount}
                </div>
              </div>
            `;
          });
          showResults(html);
        }

      } catch (error) {
        showStatus(`‚ùå Search failed: ${error.message}`, 'error');
        addLog(`Fatal error: ${error.message}`, 'error');
        showResults(`<div class="status error">Error: ${error.message}</div>`);
      } finally {
        btn.disabled = false;
      }
    }

    // Initialize
    addLog('Page loaded');
    addLog(`Supabase URL: ${CORRECT_SUPABASE_URL}`);
    addLog('Ready to search');
  </script>
</body>
</html>
