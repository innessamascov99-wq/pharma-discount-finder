<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Search Test - With Real Data</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body { font-family: system-ui; max-width: 1000px; margin: 40px auto; padding: 20px; background: #f0f4f8; }
    .container { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); }
    h1 { color: #1a202c; margin-bottom: 10px; }
    .subtitle { color: #718096; margin-bottom: 30px; }
    .search-box { display: flex; gap: 10px; margin-bottom: 20px; }
    input { flex: 1; padding: 14px; font-size: 16px; border: 2px solid #e2e8f0; border-radius: 8px; }
    input:focus { outline: none; border-color: #3182ce; }
    button { padding: 14px 28px; font-size: 16px; font-weight: 600; background: #3182ce; color: white; border: none; border-radius: 8px; cursor: pointer; }
    button:hover { background: #2c5282; }
    button:disabled { opacity: 0.6; cursor: not-allowed; }
    .quick-tests { display: flex; gap: 10px; flex-wrap: wrap; margin-bottom: 30px; }
    .quick-tests button { padding: 10px 20px; font-size: 14px; background: #48bb78; }
    .quick-tests button:hover { background: #38a169; }
    .status { padding: 16px; border-radius: 8px; margin: 15px 0; }
    .status.success { background: #c6f6d5; color: #22543d; border-left: 4px solid #38a169; }
    .status.error { background: #fed7d7; color: #742a2a; border-left: 4px solid #e53e3e; }
    .status.info { background: #bee3f8; color: #2c5282; border-left: 4px solid #3182ce; }
    .result-card { border: 1px solid #e2e8f0; padding: 20px; margin: 15px 0; border-radius: 8px; background: #f7fafc; }
    .result-card:hover { box-shadow: 0 4px 12px rgba(0,0,0,0.05); }
    .result-card h3 { color: #2d3748; margin: 0 0 8px 0; font-size: 20px; }
    .result-card .generic { color: #718096; font-size: 14px; margin-bottom: 8px; }
    .result-card .manufacturer { color: #3182ce; font-weight: 600; margin-bottom: 10px; }
    .result-card .program { background: #edf2f7; padding: 12px; border-radius: 6px; margin: 10px 0; }
    .result-card .discount { display: inline-block; background: #48bb78; color: white; padding: 6px 12px; border-radius: 6px; font-weight: 600; margin-top: 8px; }
    .result-card .phone { color: #2d3748; margin-top: 8px; }
    .relevance { display: inline-block; background: #f6ad55; color: #744210; padding: 4px 10px; border-radius: 4px; font-size: 12px; font-weight: 700; margin-left: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <h1>üîç Pharma Program Search - Live Test</h1>
    <p class="subtitle">Search 38+ pharmaceutical assistance programs with real data from Supabase</p>

    <div class="search-box">
      <input type="text" id="searchInput" placeholder="Search for medication (e.g., mounjaro, insulin, humira)" value="mounjaro">
      <button onclick="performSearch()" id="searchBtn">Search</button>
    </div>

    <div class="quick-tests">
      <button onclick="quickSearch('mounjaro')">Mounjaro</button>
      <button onclick="quickSearch('ozempic')">Ozempic</button>
      <button onclick="quickSearch('insulin')">Insulin</button>
      <button onclick="quickSearch('humira')">Humira</button>
      <button onclick="quickSearch('eliquis')">Eliquis</button>
    </div>

    <div id="status"></div>
    <div id="results"></div>
  </div>

  <script>
    const SUPABASE_URL = 'https://nuhfqkhplldontxtoxkg.supabase.co';
    const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im51aGZxa2hwbGxkb250eHRveGtnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc4NzQyODYsImV4cCI6MjA3MzQ1MDI4Nn0.ceTZ_YZtqCRv2v3UCgHM42OXdb97KrmVhnxgk0iD3eE';
    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

    function showStatus(message, type = 'info') {
      const statusDiv = document.getElementById('status');
      statusDiv.innerHTML = `<div class="status ${type}">${message}</div>`;
    }

    function displayResults(data) {
      const resultsDiv = document.getElementById('results');

      if (!data || data.length === 0) {
        resultsDiv.innerHTML = '<div class="status error">No results found. Try a different search term.</div>';
        return;
      }

      let html = `<h2 style="margin: 30px 0 20px 0; color: #2d3748;">Found ${data.length} Program(s)</h2>`;

      data.forEach((prog, i) => {
        const similarity = prog.similarity ? Math.round(prog.similarity * 100) : 'N/A';
        html += `
          <div class="result-card">
            <h3>
              ${i + 1}. ${prog.medication_name}
              ${similarity !== 'N/A' ? `<span class="relevance">${similarity}% Match</span>` : ''}
            </h3>
            <div class="generic">Generic: ${prog.generic_name || 'N/A'}</div>
            <div class="manufacturer">by ${prog.manufacturer || 'Unknown'}</div>
            <div class="program">
              <strong>${prog.program_name || 'N/A'}</strong><br>
              <span style="color: #4a5568; font-size: 14px;">${prog.program_description || 'No description available'}</span>
            </div>
            ${prog.discount_amount ? `<span class="discount">üí∞ ${prog.discount_amount}</span>` : ''}
            ${prog.phone_number ? `<div class="phone">üìû ${prog.phone_number}</div>` : ''}
            ${prog.program_url ? `<div style="margin-top: 10px;"><a href="${prog.program_url}" target="_blank" style="color: #3182ce; text-decoration: underline;">Visit Program Website ‚Üí</a></div>` : ''}
          </div>
        `;
      });
      resultsDiv.innerHTML = html;
    }

    async function performSearch() {
      const query = document.getElementById('searchInput').value.trim();
      const btn = document.getElementById('searchBtn');

      if (!query) {
        showStatus('Please enter a search term', 'error');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Searching...';
      document.getElementById('status').innerHTML = '';
      document.getElementById('results').innerHTML = '';

      showStatus(`Searching for "${query}"...`, 'info');

      try {
        const searchWords = query.toLowerCase().split(/\s+/).filter(w => w.length > 1);

        if (searchWords.length === 0) {
          showStatus('Search term too short', 'error');
          btn.disabled = false;
          btn.textContent = 'Search';
          return;
        }

        const orConditions = searchWords.flatMap(word => [
          `medication_name.ilike.%${word}%`,
          `generic_name.ilike.%${word}%`,
          `manufacturer.ilike.%${word}%`,
          `program_name.ilike.%${word}%`,
          `program_description.ilike.%${word}%`
        ]).join(',');

        console.log('Searching with conditions:', orConditions.substring(0, 100));

        const { data, error } = await supabase
          .from('pharma_programs')
          .select('*')
          .eq('active', true)
          .or(orConditions)
          .limit(50);

        if (error) {
          console.error('Search error:', error);
          showStatus(`Search failed: ${error.message}`, 'error');
          btn.disabled = false;
          btn.textContent = 'Search';
          return;
        }

        if (!data || data.length === 0) {
          showStatus(`No results found for "${query}"`, 'error');
          document.getElementById('results').innerHTML = '<div class="status info">Try searching for: mounjaro, ozempic, insulin, humira, eliquis, xarelto, trulicity, or januvia</div>';
          btn.disabled = false;
          btn.textContent = 'Search';
          return;
        }

        const results = data.map(program => {
          let score = 0;
          const medName = (program.medication_name || '').toLowerCase();
          const genName = (program.generic_name || '').toLowerCase();
          const mfg = (program.manufacturer || '').toLowerCase();

          searchWords.forEach(word => {
            if (medName === word) score += 100;
            else if (medName.startsWith(word)) score += 80;
            else if (medName.includes(word)) score += 50;

            if (genName === word) score += 90;
            else if (genName.includes(word)) score += 40;

            if (mfg.includes(word)) score += 30;
          });

          return { ...program, similarity: score / 100 };
        });

        const sorted = results
          .filter(r => r.similarity > 0)
          .sort((a, b) => b.similarity - a.similarity)
          .slice(0, 15);

        showStatus(`‚úÖ Found ${sorted.length} matching program(s)!`, 'success');
        displayResults(sorted);

      } catch (err) {
        console.error('Unexpected error:', err);
        showStatus(`Error: ${err.message}`, 'error');
      }

      btn.disabled = false;
      btn.textContent = 'Search';
    }

    function quickSearch(term) {
      document.getElementById('searchInput').value = term;
      performSearch();
    }

    document.getElementById('searchInput').addEventListener('keypress', (e) => {
      if (e.key === 'Enter') performSearch();
    });

    window.addEventListener('load', () => {
      setTimeout(() => {
        showStatus('Ready to search! Click Search or try one of the quick test buttons above.', 'info');
      }, 500);
    });
  </script>
</body>
</html>
